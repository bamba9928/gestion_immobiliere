{% extends "base.html" %}
{% load static %}
{% load tailwind_tags %}

{% block title %}État des lieux | MADA IMMO{% endblock %}

{% block extra_css %}
<style>
    /* Définition dynamique de la couleur d'accentuation */
    :root {
        {% if type_etat == "ENTREE" %}
            --accent-color: #10b981; /* emerald-500 */
            --accent-bg: rgba(16, 185, 129, 0.1);
            --accent-border: rgba(16, 185, 129, 0.2);
        {% else %}
            --accent-color: #f59e0b; /* amber-500 */
            --accent-bg: rgba(245, 158, 11, 0.1);
            --accent-border: rgba(245, 158, 11, 0.2);
        {% endif %}
    }

    /* Style général des inputs Django */
    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="email"],
    select,
    textarea {
        width: 100%;
        background-color: #0a0a0a;
        border: 1px solid #262626;
        border-radius: 0.75rem;
        padding: 0.75rem 1rem;
        color: white;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        outline: none;
        /* Pour que l'icone calendrier soit blanche en dark mode */
        color-scheme: dark;
    }

    input:focus, select:focus, textarea:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 1px var(--accent-border), 0 0 0 4px var(--accent-bg);
        transform: translateY(-1px);
    }

    /* Style spécifique pour les Checkboxes */
    input[type="checkbox"] {
        appearance: none;
        background-color: #0a0a0a;
        margin: 0;
        font: inherit;
        color: currentColor;
        width: 1.25em;
        height: 1.25em;
        border: 1px solid #404040;
        border-radius: 0.25em;
        display: grid;
        place-content: center;
        transition: all 0.2s;
        cursor: pointer;
    }

    input[type="checkbox"]::before {
        content: "";
        width: 0.65em;
        height: 0.65em;
        transform: scale(0);
        transition: 120ms transform ease-in-out;
        box-shadow: inset 1em 1em white;
        transform-origin: center;
        clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
    }

    input[type="checkbox"]:checked {
        background-color: var(--accent-color);
        border-color: var(--accent-color);
    }

    input[type="checkbox"]:checked::before {
        transform: scale(1);
    }

    /* Style spécifique pour les fichiers */
    input[type="file"] {
        background-color: #0a0a0a;
        padding: 0.5rem;
        font-size: 0.875rem;
        border-radius: 0.75rem;
        color: #737373;
        width: 100%;
        border: 1px dashed #404040;
        transition: border-color 0.2s;
    }
    input[type="file"]:hover {
        border-color: #525252;
    }
    input[type="file"]::file-selector-button {
        background-color: #262626;
        color: var(--accent-color);
        border: 1px solid #404040;
        padding: 0.35rem 0.85rem;
        border-radius: 0.5rem;
        margin-right: 1rem;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        transition: all 0.2s;
    }
    input[type="file"]::file-selector-button:hover {
        background-color: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

    {# --- HEADER --- #}
    <div class="mb-8">
        <a href="{% url 'bail_detail' bail.id %}" class="inline-flex items-center gap-2 text-sm text-neutral-400 hover:text-white transition-colors group">
            <svg class="w-4 h-4 transition-transform group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
            Retour au bail
        </a>
    </div>

    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-8">
        <div>
            <div class="flex items-center gap-3 mb-3">
                <span class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider
                             {% if type_etat == 'ENTREE' %}
                                bg-emerald-500/10 text-emerald-500 border border-emerald-500/20
                             {% else %}
                                bg-amber-500/10 text-amber-500 border border-amber-500/20
                             {% endif %}">
                    {% if type_etat == "ENTREE" %}
                        <span class="flex items-center gap-1.5"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span> Entrée</span>
                    {% else %}
                        <span class="flex items-center gap-1.5"><span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span> Sortie</span>
                    {% endif %}
                </span>
                <span class="text-neutral-500 text-sm font-medium px-2 py-0.5 rounded bg-neutral-900 border border-neutral-800">{{ bail.bien.get_type_bien_display }}</span>
            </div>
            <h1 class="text-3xl font-black text-white tracking-tight mb-1">État des lieux</h1>
            <p class="text-neutral-400 text-sm">
                Bien concerné : <span class="text-white font-medium">{{ bail.bien.titre }}</span>
            </p>
        </div>

        <div class="flex items-center gap-4 bg-neutral-900/50 p-4 rounded-xl border border-neutral-800 shadow-sm">
            <div class="h-12 w-12 rounded-xl bg-neutral-800 flex items-center justify-center text-neutral-400 font-bold border border-neutral-700 shadow-inner">
                {{ bail.locataire.username|make_list|first|upper }}
            </div>
            <div>
                <p class="text-[10px] text-neutral-500 uppercase font-bold tracking-wider">Locataire</p>
                <p class="text-sm text-white font-bold">{{ bail.locataire.get_full_name|default:bail.locataire.username }}</p>
                <p class="text-xs text-neutral-500">Bail #{{ bail.id }}</p>
            </div>
        </div>
    </div>

    {# --- FORMULAIRE --- #}
    <div class="bg-neutral-900/50 backdrop-blur-sm border border-neutral-800 rounded-2xl p-6 md:p-8 shadow-2xl relative overflow-hidden">

        <div class="absolute top-0 right-0 w-64 h-64 rounded-full blur-3xl opacity-5 pointer-events-none -translate-y-1/2 translate-x-1/2
             {% if type_etat == 'ENTREE' %}bg-emerald-500{% else %}bg-amber-500{% endif %}"></div>

        <form method="post" enctype="multipart/form-data" class="space-y-8 relative z-10">
            {% csrf_token %}

            {% if form.non_field_errors %}
                <div class="p-4 rounded-xl bg-red-500/10 border border-red-500/20 text-red-200 text-sm flex items-start gap-3">
                    <svg class="w-5 h-5 text-red-400 shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <div>{{ form.non_field_errors }}</div>
                </div>
            {% endif %}

            <div class="space-y-6">
                {% for field in form %}
                    <div class="group">
                        {# Gestion différente si c'est une Checkbox (Booléen) #}
                        {% if field.field.widget.input_type == 'checkbox' %}
                            <div class="flex items-center gap-3 p-3 rounded-xl border border-neutral-800 bg-black/20 hover:border-neutral-700 transition-colors">
                                <div class="flex items-center h-5">
                                    {{ field }}
                                </div>
                                <div class="text-sm">
                                    <label for="{{ field.id_for_label }}" class="font-medium text-neutral-200 cursor-pointer select-none">
                                        {{ field.label }}
                                    </label>
                                    {% if field.help_text %}
                                        <p class="text-xs text-neutral-500">{{ field.help_text }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        {% else %}
                            {# Layout standard pour les autres champs #}
                            <label for="{{ field.id_for_label }}" class="block text-xs font-bold uppercase tracking-wider text-neutral-500 mb-2 group-focus-within:text-white transition-colors">
                                {{ field.label }} {% if field.field.required %}<span class="{% if type_etat == 'ENTREE' %}text-emerald-500{% else %}text-amber-500{% endif %}">*</span>{% endif %}
                            </label>

                            <div class="relative">
                                {{ field }}
                            </div>

                            {% if field.help_text %}
                                <p class="text-xs text-neutral-500 mt-1.5">{{ field.help_text }}</p>
                            {% endif %}
                        {% endif %}

                        {% if field.errors %}
                            <ul class="text-xs text-red-400 space-y-1 mt-2 animate-pulse">
                                {% for error in field.errors %}
                                    <li class="flex items-center gap-1.5">
                                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                                        {{ error }}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>

            <div class="pt-8 border-t border-neutral-800 flex flex-col-reverse sm:flex-row items-center justify-end gap-4">
                <a href="{% url 'bail_detail' bail.id %}"
                   class="w-full sm:w-auto text-center px-6 py-3 rounded-xl border border-neutral-700 text-neutral-300 hover:text-white hover:bg-neutral-800 transition-all text-sm font-bold">
                    Annuler
                </a>

                <button type="submit"
                        class="w-full sm:w-auto px-8 py-3 rounded-xl text-white font-bold text-sm shadow-lg transform hover:-translate-y-0.5 transition-all duration-200 flex items-center justify-center gap-2
                               {% if type_etat == 'ENTREE' %}
                                    bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-500 hover:to-emerald-400 shadow-emerald-900/20 hover:shadow-emerald-900/40
                               {% else %}
                                    bg-gradient-to-r from-amber-600 to-amber-500 hover:from-amber-500 hover:to-amber-400 shadow-amber-900/20 hover:shadow-amber-900/40
                               {% endif %}">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    Enregistrer l'état des lieux
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}